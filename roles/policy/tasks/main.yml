---
- name: Detect firewall backend when auto
  ansible.builtin.set_fact:
    firewall_backend_resolved: >-
      {{
        'nftables' if (firewall_backend == 'auto' and (ansible_facts.packages is defined and (ansible_facts.packages['nftables'] | default([])) | length > 0))
        else ('iptables' if firewall_backend == 'auto' else firewall_backend)
      }}
  when: firewall_backend_resolved is not defined

- name: Ensure backend is set
  ansible.builtin.set_fact:
    firewall_backend_resolved: "{{ firewall_backend_resolved | default(firewall_backend) }}"
  when: firewall_backend_resolved is not defined or firewall_backend_resolved == 'auto'

- name: Publish firewall facts
  ansible.builtin.set_fact:
    firewall_facts:
      backend: "{{ firewall_backend_resolved }}"
      defaults: "{{ firewall_defaults }}"

- name: Basic validation
  ansible.builtin.assert:
    that:
      - firewall_backend_resolved in ['nftables', 'iptables', 'firewalld']
    fail_msg: "Unsupported firewall backend: {{ firewall_backend_resolved }}. Supported: nftables, iptables, firewalld"
