---
- name: Ensure nftables package present
  ansible.builtin.package:
    name: nftables
    state: present

- name: Check if existing config exists
  ansible.builtin.stat:
    path: "{{ nftables_conf_path }}"
  register: nftables_config_stat

- name: Backup existing config if present
  ansible.builtin.copy:
    src: "{{ nftables_conf_path }}"
    dest: "{{ nftables_conf_path }}.backup-{{ ansible_date_time.epoch }}"
    remote_src: true
    mode: '0600'
  when:
    - nftables_backup | bool
    - nftables_config_stat.stat.exists | default(false)

- name: Render staged config
  ansible.builtin.template:
    src: nftables.conf.j2
    dest: "{{ nftables_conf_path }}.staged"
    mode: '0600'
  notify: Restart nftables

- name: Validate staged config
  ansible.builtin.command:
    cmd: "nft -c -f {{ nftables_conf_path }}.staged"
  changed_when: false

- name: Apply nftables config atomically
  block:
    - name: Promote staged config
      ansible.builtin.copy:
        src: "{{ nftables_conf_path }}.staged"
        dest: "{{ nftables_conf_path }}"
        remote_src: true
        mode: '0600'

    - name: Apply nftables ruleset
      ansible.builtin.command:
        cmd: "nft -f {{ nftables_conf_path }}"
      changed_when: true
      register: nftables_apply_result

  rescue:
    - name: Rollback to backup on failure
      ansible.builtin.copy:
        src: "{{ nftables_conf_path }}.backup-{{ ansible_date_time.epoch }}"
        dest: "{{ nftables_conf_path }}"
        remote_src: true
        mode: '0600'
      when: nftables_config_stat.stat.exists | default(false)

    - name: Apply rollback config
      ansible.builtin.command:
        cmd: "nft -f {{ nftables_conf_path }}"
      when: nftables_config_stat.stat.exists | default(false)

    - name: Fail with error message
      ansible.builtin.fail:
        msg: "Failed to apply nftables config. Rolled back to previous configuration."

  when: not (firewall_validate_only | default(false))

- name: Clean up staged config
  ansible.builtin.file:
    path: "{{ nftables_conf_path }}.staged"
    state: absent

- name: Enable and start nftables service
  ansible.builtin.service:
    name: "{{ nftables_service_name }}"
    enabled: true
    state: started
