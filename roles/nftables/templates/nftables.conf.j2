#!/usr/sbin/nft -f
# {{ ansible_managed }}
# nftables configuration generated by ansible-collection-firewall

flush ruleset

table inet filter {
    # Define sets for address groups
{% for group_name, addresses in (firewall_objects.address_groups | default({})).items() %}
    set {{ group_name }} {
        type ipv4_addr
        elements = { {{ addresses | join(', ') }} }
    }
{% endfor %}

    # Define sets for port groups
{% for group_name, ports in (firewall_objects.port_groups | default({})).items() %}
    set {{ group_name }} {
        type inet_service
        elements = { {{ ports | join(', ') }} }
    }
{% endfor %}

    chain input {
        type filter hook input priority 0; policy {{ firewall_defaults.policy_v4 | default('drop') }};

        # Allow established/related connections
        ct state established,related accept

        # Allow loopback
{% if firewall_defaults.allow_loopback | default(true) %}
        iif lo accept
{% endif %}

        # Drop invalid connections
        ct state invalid drop

        # Allow ICMP (ping)
{% if firewall_defaults.allow_icmp | default(true) %}
        ip protocol icmp accept
        ip6 nexthdr icmpv6 accept
{% endif %}

        # SSH guard - always allow SSH to prevent lockouts
{% if firewall_defaults.ssh_guard | default(true) %}
        tcp dport 22 accept comment "SSH guard - prevent lockout"
{% endif %}

        # User-defined rules
{% for rule in firewall_rules | default([]) %}
{% if rule.direction | default('inbound') == 'inbound' %}
        # {{ rule.name | default('unnamed rule') }}
{% if rule.source_group is defined %}
        ip saddr @{{ rule.source_group }} {% if rule.dest_port is defined %}tcp dport {{ rule.dest_port }}{% endif %} {{ rule.action | default('accept') }}{% if rule.log | default(false) %} log prefix "{{ rule.name | default('FW') }}: "{% endif %}

{% elif rule.source is defined %}
        ip saddr {{ rule.source }} {% if rule.dest_port is defined %}tcp dport {{ rule.dest_port }}{% endif %} {{ rule.action | default('accept') }}{% if rule.log | default(false) %} log prefix "{{ rule.name | default('FW') }}: "{% endif %}

{% elif rule.dest_port is defined %}
        tcp dport {{ rule.dest_port }} {{ rule.action | default('accept') }}{% if rule.log | default(false) %} log prefix "{{ rule.name | default('FW') }}: "{% endif %}

{% endif %}
{% endif %}
{% endfor %}

        # Log dropped packets (optional)
{% if firewall_defaults.log_drops | default(false) %}
        log prefix "nftables dropped: " counter drop
{% else %}
        counter drop
{% endif %}
    }

    chain forward {
        type filter hook forward priority 0; policy {{ firewall_defaults.policy_forward | default('drop') }};
        ct state established,related accept
        ct state invalid drop
    }

    chain output {
        type filter hook output priority 0; policy {{ firewall_defaults.policy_output | default('accept') }};
        ct state established,related accept
    }
}
