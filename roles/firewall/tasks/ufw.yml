---
- name: Install UFW
  ansible.builtin.package:
    name: ufw
    state: present

- name: Configure UFW logging
  community.general.ufw:
    logging: "{{ ufw_logging }}"

- name: Configure UFW default policies
  community.general.ufw:
    direction: "{{ item.direction }}"
    policy: "{{ item.policy }}"
  loop:
    - { direction: incoming, policy: "{{ firewall_default_policy_input | lower }}" }
    - { direction: outgoing, policy: "{{ firewall_default_policy_output | lower }}" }
    - { direction: routed, policy: "{{ firewall_default_policy_forward | lower }}" }

- name: Allow SSH before enabling UFW
  community.general.ufw:
    rule: allow
    port: "{{ firewall_ssh_port }}"
    proto: tcp
  when: firewall_allow_ssh

- name: Configure UFW rules
  community.general.ufw:
    rule: "{{ item.state | default('allow') }}"
    port: "{{ item.port | string }}"
    proto: "{{ item.protocol | default('tcp') }}"
    comment: "{{ item.name | default(omit) }}"
  loop: "{{ firewall_rules }}"
  when: firewall_rules | length > 0

- name: Enable UFW
  community.general.ufw:
    state: enabled
  when: firewall_enabled
